- en: Spawning tasks
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 任务创建
- en: 原文：[https://rust-exercises.com/100-exercises/08_futures/02_spawn.html](https://rust-exercises.com/100-exercises/08_futures/02_spawn.html)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://rust-exercises.com/100-exercises/08_futures/02_spawn.html](https://rust-exercises.com/100-exercises/08_futures/02_spawn.html)
- en: 'Your solution to the previous exercise should look something like this:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 你对上一个练习的解决方案应该看起来像这样：
- en: '[PRE0]'
  id: totrans-3
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This is not bad!
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 这并不坏！
- en: If a long time passes between two incoming connections, the `echo` function
    will be idle (since `TcpListener::accept` is an asynchronous function), thus allowing
    the executor to run other tasks in the meantime.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 如果两个传入连接之间有很长时间的间隔，`echo` 函数将处于空闲状态（因为 `TcpListener::accept` 是一个异步函数），从而允许执行器在此期间运行其他任务。
- en: But how can we actually have multiple tasks running concurrently?
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 但我们如何实际上让多个任务并发运行呢？
- en: If we always run our asynchronous functions until completion (by using `.await`),
    we'll never have more than one task running at a time.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们总是运行我们的异步函数直到完成（通过使用 `.await`），我们一次将不会有超过一个任务在运行。
- en: This is where the `tokio::spawn` function comes in.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 这就是 `tokio::spawn` 函数发挥作用的地方。
- en: '[`tokio::spawn`](#tokiospawn)'
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[`tokio::spawn`](#tokiospawn)'
- en: '`tokio::spawn` allows you to hand off a task to the executor, **without waiting
    for it to complete**.'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: '`tokio::spawn` 允许你将任务交给执行器，**而不需要等待它完成**。'
- en: Whenever you invoke `tokio::spawn`, you're telling `tokio` to continue running
    the spawned task, in the background, **concurrently** with the task that spawned
    it.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 每次你调用 `tokio::spawn` 时，你都在告诉 `tokio` 在后台继续运行创建的任务，**与创建它的任务并发**。
- en: 'Here''s how you can use it to process multiple connections concurrently:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是如何使用它来同时处理多个连接的：
- en: '[PRE1]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '[Asynchronous blocks](#asynchronous-blocks)'
  id: totrans-14
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[异步块](#asynchronous-blocks)'
- en: 'In this example, we''ve passed an **asynchronous block** to `tokio::spawn`:
    `async move { /* */ }` Asynchronous blocks are a quick way to mark a region of
    code as asynchronous without having to define a separate async function.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，我们向 `tokio::spawn` 传递了一个 **异步块**：`async move { /* */ }`。异步块是标记代码区域为异步的一种快捷方式，而无需定义单独的异步函数。
- en: '[`JoinHandle`](#joinhandle)'
  id: totrans-16
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[`JoinHandle`](#joinhandle)'
- en: '`tokio::spawn` returns a `JoinHandle`.'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '`tokio::spawn` 返回一个 `JoinHandle`。'
- en: You can use `JoinHandle` to `.await` the background task, in the same way we
    used `join` for spawned threads.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用 `JoinHandle` 来 `.await` 背景任务，就像我们使用 `join` 为创建的线程做的那样。
- en: '[PRE2]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '[Panic boundary](#panic-boundary)'
  id: totrans-20
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[恐慌边界](#panic-boundary)'
- en: If a task spawned with `tokio::spawn` panics, the panic will be caught by the
    executor.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果使用 `tokio::spawn` 创建的任务发生恐慌，恐慌将被执行器捕获。
- en: If you don't `.await` the corresponding `JoinHandle`, the panic won't be propagated
    to the spawner. Even if you do `.await` the `JoinHandle`, the panic won't be propagated
    automatically. Awaiting a `JoinHandle` returns a `Result`, with [`JoinError`](https://docs.rs/tokio/latest/tokio/task/struct.JoinError.html)
    as its error type. You can then check if the task panicked by calling `JoinError::is_panic`
    and choose what to do with the panic—either log it, ignore it, or propagate it.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你没有 `.await` 对应的 `JoinHandle`，恐慌不会传播到创建者。即使你 `.await` 了 `JoinHandle`，恐慌也不会自动传播。等待
    `JoinHandle` 返回一个 `Result`，其错误类型为 `JoinError`。然后你可以通过调用 `JoinError::is_panic`
    来检查任务是否发生恐慌，并决定如何处理恐慌——要么记录它，要么忽略它，要么传播它。
- en: '[PRE3]'
  id: totrans-23
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '[`std::thread::spawn` vs `tokio::spawn`](#stdthreadspawn-vs-tokiospawn)'
  id: totrans-24
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[`std::thread::spawn` 与 `tokio::spawn`](#stdthreadspawn-vs-tokiospawn)'
- en: You can think of `tokio::spawn` as the asynchronous sibling of `std::thread::spawn`.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以将 `tokio::spawn` 视为 `std::thread::spawn` 的异步兄弟。
- en: 'Notice a key difference: with `std::thread::spawn`, you''re delegating control
    to the OS scheduler. You''re not in control of how threads are scheduled.'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 注意一个关键区别：使用 `std::thread::spawn`，你是在将控制权委托给操作系统调度器。你无法控制线程的调度方式。
- en: With `tokio::spawn`, you're delegating to an async executor that runs entirely
    in user space. The underlying OS scheduler is not involved in the decision of
    which task to run next. We're in charge of that decision now, via the executor
    we chose to use.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `tokio::spawn`，你是在委托给一个完全在用户空间运行的异步执行器。底层的操作系统调度器不参与决定下一个运行哪个任务。现在，我们通过选择的执行器来负责这个决定。
- en: '[Exercise](#exercise)'
  id: totrans-28
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[练习](#exercise)'
- en: The exercise for this section is located in [`08_futures/02_spawn`](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/08_futures/02_spawn)
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 本节练习位于 `[08_futures/02_spawn](https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/08_futures/02_spawn)`。
