# 基准测试

> 原文：[`howqueryengineswork.com/17-benchmarks.html`](https://howqueryengineswork.com/17-benchmarks.html)

每个查询引擎在性能、可扩展性和资源需求方面都是独特的，通常会有不同的权衡。基准测试帮助我们了解这些特性，并就针对特定工作负载使用哪个查询引擎做出明智的决定。它们还有助于查询引擎开发者识别性能退化并跟踪改进。

## 测量性能

性能通常是衡量最简单的特性，通常指的是执行特定操作所需的时间。例如，可以构建基准测试来衡量特定查询或查询类别的性能。

性能测试通常涉及多次执行查询并测量经过的时间。

## 测量可扩展性

可扩展性是一个多义词，有各种不同的类型。术语可扩展性通常指的是性能如何随着影响性能的一些变量的不同值而变化。

一个例子是测量可扩展性，随着总数据量的增加来发现性能是如何受到影响的，例如查询 10GB 数据与 100GB 或 1TB 数据时的性能。一个常见的目标是展示线性可扩展性，这意味着查询 100GB 数据应该比查询 10GB 数据花费 10 倍的时间。线性可扩展性使用户能够轻松地推理预期行为。

影响性能的其他变量示例包括：

+   并发用户、请求或查询数量。

+   数据分区数量。

+   物理磁盘数量。

+   核心数量。

+   节点数量。

+   可用 RAM 量。

+   硬件类型（例如，树莓派与台式机）。

## 并发性

当基于并发请求数量测量可扩展性时，我们通常更感兴趣的是吞吐量（在特定时间段内执行的查询总数）而不是单个查询的持续时间，尽管我们通常也会收集这些信息。

## 自动化

基准测试通常运行时间较长，自动化是必不可少的，以便经常运行基准测试，可能每天或每周运行一次，以便能够尽早发现性能退化。

自动化对于确保基准测试的一致执行和收集分析结果时可能需要的所有相关细节也是非常重要的。

在执行基准测试时，以下是一些应该收集的数据类型示例：

### 硬件配置

+   硬件类型

+   CPU 核心数量

+   可用内存和磁盘空间

+   操作系统名称和版本

### 环境

+   环境变量（注意不要泄露机密信息）

### 基准配置

+   使用的基准软件版本

+   测试软件的版本

+   任何配置参数或文件

+   被查询的任何数据文件的文件名

+   数据文件的数据大小和校验和

+   执行的查询的详细信息

### 基准测试结果

+   基准测试开始的时间/日期

+   每个查询的开始时间和结束时间

+   任何失败查询的错误信息

## 比较基准测试

比较软件发布之间的基准测试非常重要，这样就可以清楚地看到性能特性的变化，并可以进行进一步的研究。基准测试产生大量数据，通常难以手动比较，因此构建帮助这一过程的工具可能是有益的。

与直接比较两组性能数据相比，工具可以对数据进行“diff”操作，并显示同一基准测试两次或多次运行之间的百分比差异。能够生成显示多次基准测试运行的图表也非常有用。

## 可视化基准测试结果

以表格形式呈现的原始基准测试数据可能难以解释。图表和图形可以使看到模式、识别异常以及向他人传达结果变得容易得多。

在可视化性能数据时，考虑绘制吞吐量而不是原始执行时间。吞吐量，通常以每分钟或每秒查询数表示，提供了衡量系统容量的更直观的度量。如果一个查询需要 5 秒钟来执行，那么在单个线程上，系统可以处理每分钟 12 个查询。这种框架使得理解现实世界的容量变得更容易。

折线图非常适合显示性能如何随着 CPU 核心或内存等资源的增加而扩展，或者随着数据大小的增加而扩展。条形图用于并排比较不同的配置或不同的查询引擎。

在创建可视化时，请小心使用适当的刻度。将 y 轴从零开始而不是从某个任意值开始，可以更真实地表示数据点之间的差异。在处理跨越几个数量级的数值数据时，使用对数刻度可能是合适的。

## 事务处理委员会（TPC）基准测试

事务处理委员会是一个数据库供应商的联盟，它们合作创建和维护各种数据库基准测试套件，以便在供应商的系统之间进行公平的比较。当前的 TPC 成员公司包括微软、甲骨文、IBM、惠普企业、AMD、英特尔和英伟达。

第一个基准测试，TPC-A，于 1989 年发布，此后还创建了其他基准测试。TPC-C 是一个著名的 OLTP 基准测试，用于比较传统的 RDBMS 数据库，而 TPC-H（已停用）和 TPC-DS 通常用于衡量“大数据”查询引擎的性能。

TPC 基准被看作是行业中的“黄金标准”，但完全实施起来既复杂又耗时。此外，这些基准的结果只能由 TPC 成员发布，并且只有在基准经过 TPC 审计之后才能发布。以 TPC-DS 为例，截至写作时，唯一发布过官方结果的只有阿里巴巴、H2C、SuperMicro 和 Databricks。

然而，TPC 有一个公平使用政策，允许非成员根据 TPC 基准创建非官方基准，只要遵循某些条件，例如在提及 TPC 时加上“源自 TPC”的前缀。例如，“源自 TPC-DS 查询 14 的查询性能”。还必须维护 TPC 版权声明和许可协议。对可以发布的指标类型也有限制。

许多开源项目只是测量 TPC 基准套件中单个查询的执行时间，并将其作为跟踪性能随时间变化以及与其他查询引擎进行比较的一种方式。

## 常见错误

在设计和运行基准测试时，有一些常见的错误需要避免。

查询的第一次运行通常比后续运行慢，这是由于即时编译、缓存填充和其他启动效应造成的。在收集测量数据之前运行几个预热迭代可以帮助确保结果反映稳态性能而不是冷启动行为。

在同时进行其他工作的机器上运行基准测试可能会引入显著的可变性。专用基准环境，或者至少确保最小化背景活动，可以产生更可靠的结果。

只运行一次查询并报告该结果告诉你很少。运行多次迭代并报告统计数据，如平均值、中位数和标准差，可以更全面地了解典型性能及其可变性。

使用小型数据集或极其简单的查询的基准测试可能无法揭示对实际工作负载重要的性能特征。使用真实的数据大小和查询复杂度对于获得有意义的成果至关重要。

只展示使你的查询引擎看起来好的结果可能很有吸引力，但发布完整的结果，包括性能较差的查询，可以建立信誉并帮助识别改进领域。

## 构建自己的基准

虽然行业标准基准如 TPC-DS 对于比较不同的系统很有价值，但它们可能无法反映你的特定工作负载。基于你的应用程序中的真实查询构建自定义基准可以提供更相关的见解。

在构建自定义基准时，首先确定对用户最重要的查询。这些可能是执行最频繁的查询，或者是对延迟最敏感的查询。对你的应用程序进行仪器化以收集查询日志，然后选择代表性的查询进行基准测试。

创建与生产数据在大小、分布和模式复杂性方面相匹配的数据集。合成数据生成器可以帮助创建具有可控特性的大型数据集，但请注意，随机生成的数据可能具有与真实数据不同的统计特性。

详细记录你的基准测试方法，以便结果可以重现。这包括不仅限于查询和数据，还包括硬件、操作系统以及可能影响性能的任何配置设置。

*本书也以 ePub、MOBI 和 PDF 格式从[`leanpub.com/how-query-engines-work`](https://leanpub.com/how-query-engines-work)购买*。

**版权所有 © 2020-2025 安迪·格鲁夫。保留所有权利**。
