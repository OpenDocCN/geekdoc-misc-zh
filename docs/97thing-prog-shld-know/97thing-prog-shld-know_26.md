# 不要忽视那个错误！

# 不要忽视那个错误！

> *一天晚上我在街上走着去酒吧见一些朋友。我们有段时间没喝啤酒了，我很期待再次见到他们。在我的匆忙中，我没注意到我在哪里。我绊倒在路边的路缘石上，摔倒在地。嗯，我不注意，这是我自找的吧，我猜。*
> 
> *我的腿受伤了，但我急着去见朋友。所以我振作起来继续前行。当我走得更远时，疼痛加剧了。尽管我最初将其视为震惊，但我迅速意识到有问题。*
> 
> *但我还是匆匆赶往酒吧。我到达时已经非常痛苦了。我度过了不愉快的夜晚，因为我分心得厉害。第二天早上我去看医生，发现我胫骨骨折了。如果我在感到疼痛时停下来，我就能防止我因继续行走而造成的额外损伤。可能是我一生中最糟糕的第二天早上。*

太多的程序员写出像我那场灾难般的代码。

*错误，什么错误？不会很严重的。真的。我可以忽略它的。* 这不是一个制作可靠代码的成功策略。事实上，这只是纯粹的懒惰。（错误的一种。）无论你认为代码中错误的可能性有多小，你都应该始终检查并处理它。每一次都是如此。如果你不这样做，你并没有节省时间：你正在为将来存储潜在的问题。

我们以多种方式报告代码中的错误，包括：

+   **返回代码**可用作函数的结果值，意味着“它没用”。错误返回代码太容易被忽视了。你在代码中看不到任何突出问题的东西。事实上，忽略某些标准 C 函数的返回值已成为标准做法。你多久检查一次 printf 的返回值？

+   **errno** 是一个奇怪的 C 异常，一个单独的全局变量，用来表示错误。它很容易被忽视，难以使用，并导致各种各样的问题——例如，当你有多个线程调用同一个函数时会发生什么？有些平台在这里为你屏蔽痛苦；其他则不然。

+   **异常** 是一种更结构化、由语言支持的信号和处理错误的方式。你不可能忽略它们。或者你能？我见过很多这样的代码：

```
try {
    // ...do something...
}
catch (...) {} // ignore errors 
```

这个可怕构造的救赎之处在于，它突显了你正在做一些道德上可疑的事情。

如果你忽视一个错误，视而不见，并假装什么都没发生，你会承担很大的风险。就像我的腿最终比我立即停下来时更糟糕一样，不顾一切地继续下去会导致非常复杂的失败。尽早解决问题。记账要及时。

不处理错误会导致：

+   **脆弱的代码。** 充满令人兴奋的、难以发现的错误的代码。

+   **不安全的代码。** 黑客经常利用糟糕的错误处理方式来入侵软件系统。

+   **结构不佳。** 如果你的代码中有一些错误是令人厌烦的，你可能有一个糟糕的接口。设计它，使错误不那么显眼，处理它们也不那么繁琐。

就像你应该检查代码中的所有潜在错误一样，你需要暴露接口中所有潜在错误的条件。不要隐藏它们，假装你的服务总是正常工作。

为什么我们不检查错误？有许多常见的借口。你同意其中哪些？你会如何反驳每一个？

+   错误处理会使代码流程混乱，使其更难阅读，更难发现“正常”执行流程。

+   这是额外的工作，而且我有一个迫在眉睫的截止日期。

+   我知道这个函数调用将*永远*不会返回错误（printf 总是有效，malloc 总是返回新内存——如果失败，我们会有更大的问题……）。

+   这只是一个玩具程序，不需要达到生产水平的程度。

作者：[皮特·古德利夫](http://programmer.97things.oreilly.com/wiki/index.php/Pete_Goodliffe)
