# API 设计的黄金法则

# API 设计的黄金法则

API 设计很困难，特别是在大型项目中。如果你正在设计一个将拥有数百甚至数千用户的 API，你必须考虑未来如何修改它以及你的更改是否可能破坏客户端代码。此外，你必须考虑你的 API 用户如何影响你。如果你的 API 类中的一个方法在内部使用自己的方法，你必须记住用户可能会对你的类进行子类化并覆盖它，这可能是灾难性的。你将无法更改该方法，因为一些用户已经赋予它不同的含义。你未来的内部实现选择取决于你的用户。

API 开发者以各种方式解决这个问题，但最简单的方法是锁定 API。如果你在 Java 中工作，你可能会诱惑于将大部分类和方法设为 final。在 C#中，你可能会将类和方法设为 sealed。无论你使用的是哪种语言，你可能会倾向于通过单例模式呈现你的 API，或者使用静态工厂方法，以便防止他人覆盖行为并以可能限制你后续选择的方式使用你的代码。这一切看起来都很合理，但真的吗？

在过去的十年里，我们逐渐意识到单元测试是实践中极其重要的一部分，但这个教训并没有完全渗透到行业中。证据无处不在。拿一个任意未经测试的使用第三方 API 的类，尝试为其编写单元测试。大多数情况下，你会遇到麻烦。你会发现使用 API 的代码像胶水一样粘在一起。没有办法模拟 API 类，以便你可以感知你的代码与它们的交互，或者为测试提供返回值。

随着时间的推移，情况会变得更好，但前提是我们开始将测试视为设计 API 时的一个真实用例。不幸的是，这比仅仅测试我们的代码要复杂一些。这就是**API 设计的黄金法则**的所在：*仅仅为你开发的 API 编写测试是不够的；你必须为使用你的 API 的代码编写单元测试。当你这样做时，你将亲身体会到用户在尝试独立测试他们的代码时将不得不克服的障碍。*

没有一种方法可以让开发者轻松测试使用你的 API 的代码。`static`、`final`和`sealed`并不是本质上的坏构造。它们有时候是有用的。但重要的是要意识到测试问题，并且，为了做到这一点，你必须亲自体验。一旦你这样做了，你就可以像对待任何其他设计挑战一样对待它。

作者：[迈克尔·菲瑟斯](http://programmer.97things.oreilly.com/wiki/index.php/Michael_Feathers)
