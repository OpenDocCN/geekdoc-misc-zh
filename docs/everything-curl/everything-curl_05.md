# 网络和协议

# 网络和协议

在深入讨论如何使用 curl 完成任务之前，让我们看看这些网络是什么以及它是如何工作的，使用简化和一些小技巧来提供一个简单的概述。

基础知识在网络简化章节中，试图从 curl 的角度绘制网络是什么的简单图像，以及协议部分解释了“协议”究竟是什么以及它是如何工作的。

# 网络简化

## 网络简化

网络意味着在互联网上的两个端点之间进行通信。互联网只是一堆相互连接的机器（实际上是计算机），每台机器都使用自己的私有地址（称为 IP 地址）。每台机器拥有的地址可以是不同类型的，甚至可以有临时地址。这些计算机通常被称为主机。

你坐在前面的计算机、平板电脑或手机通常被称为“客户端”，而你想要与之交换数据的远程机器被称为“服务器”。客户端和服务器之间的主要区别在于它们在这里扮演的角色。在随后的操作中，角色可以互换。

### 哪台机器

当你想要向外部的一台机器（服务器）发起传输时，通常不知道其 IP 地址，而是通常知道其名称。你要与之通信的机器的名称嵌入在你使用 curl 时处理的 URL 中。

你可能会使用类似"[`example.com/index.html`](http://example.com/index.html)"的网址，这意味着你将连接并与名为 example.com 的主机通信。

### 主机名解析

一旦我们知道主机名，我们需要弄清楚该主机有哪些 IP 地址，以便我们可以联系它。

将名称转换为 IP 地址通常称为“名称解析”。名称被“解析”为一组地址。这通常由“DNS 服务器”完成，DNS 就像一个大查找表，可以将名称转换为地址——实际上是互联网上的所有名称。你的计算机通常已经知道运行 DNS 服务器的计算机的地址，因为这是网络设置的一部分。

curl 因此会询问 DNS 服务器：“你好，请给我 example.com 的所有地址”，服务器会回复一个列表。或者在你拼写错误的情况下，它可以回答该名称不存在。

### 建立连接

有了要联系的主机的 IP 地址列表，curl 发送一个“连接请求”。curl 要建立的连接称为 TCP，它的工作方式有点像在两台计算机之间连接一根看不见的绳子。一旦建���，它可以用来在两个方向发送数据流。

当 curl 获取主机的地址列表时，实际上会在连接时遍历该地址列表，如果一个失败，它将尝试连接到下一个，直到其中一个起作用或全部失败。

### 连接到“端口号”

当使用 TCP 连接到远程服务器时，客户端选择在哪个端口号上进行连接。端口号只是一个专门为特定服务提供的位置，允许同一服务器同时监听其他端口号上的其他服务。

大多数常见协议都有客户端和服务器使用的默认端口号。例如，当使用“[`example.com/index.html`](http://example.com/index.html)” URL 时，该 URL 指定了一个称为“http”的方案，告诉客户端默认情况下应该尝试服务器上的 TCP 端口号 80。URL 可以选择提供另一个自定义端口号，但如果未指定任何特殊内容，则将使用 URL 中使用的方案的默认端口。

### TLS

在建立 TCP 连接后，许多传输将要求双方在继续之前协商更好的安全级别，通常是 TLS；传输层安全性。如果使用了 TLS，客户端和服务器将首先进行 TLS 握手，只有在成功后才会继续。

### 传输数据

当连接的“字符串”我们称之为 TCP 附加到远程计算机（并且我们已经进行了可能的额外 TLS 握手）时，两台机器之间建立了连接，然后可以使用该连接交换数据。该通信使用“协议”进行，如下一章节所讨论的。

# 协议

## 协议

用于请求发送数据的语言，无论是单向还是双向，称为**协议**。协议准确描述了如何向服务器请求数据，或者告诉服务器有数据到来。

协议通常由 IETF（[互联网工程任务组](http://www.ietf.org)）定义，该组织托管描述每个协议工作原理的 RFC 文档：客户端和服务器应该如何操作以及发送什么等等。

## curl 支持哪些协议？

curl 支持允许在单向或双向传输数据的协议。通常我们也限制自己使用在 RFC 中描述了“URI 格式”或至少是广泛使用的协议，因为 curl 主要使用 URL（实际上是 URI）作为指定传输的输入关键。

最新的 curl（截至本文撰写时）支持这些协议：

DICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMB, SMBS, SMTP, SMTPS, TELNET, TFTP

为了进一步复杂化问题，协议通常也存在不同版本或变种。

## 还有哪些其他协议？

世界上充满了协议，新旧各种协议层出不穷。旧协议被抛弃和淘汰，新协议被引入。从来没有一个稳定的状态，但情况每天都在变化，每年都在变化。您可以放心，将来将会在上述列表中添加新的协议，并且已列出的协议也将有新版本。

当然，现有的协议列表中尚未支持的其他协议已经存在。我们愿意支持更多符合一般 curl 范例的协议，我们只需要开发人员为其编写必要的代码调整。

## 协议是如何开发的？

通常，现有协议的新版本和全新的协议通常由认为现有协议不够好的人或团队开发。它们的某些方面使它们不适合特定的用例，或者可能会出现一些新的想法，可以应用于改进事物。

当然，没有什么能阻止任何人在自己的后院自己愉快地开发协议，但是主要的协议通常在相当早的阶段被引入到 IETF，然后在那里讨论、完善、辩论和精炼，最终希望转变为已发布的 RFC 文档。

软件开发人员会阅读 RFC 规范，并根据对这些文档中的词语的解释，在世界上部署他们的代码。有时会发现某些规范存在着极为不同的解释，或者有时工程师只是懒得遵循规范中的建议，部署了一些不符合规范的东西。编写与规范的其他实现相互操作的软件因此可能会变得很困难。

## 协议会发生多大程度的变化？

像软件一样，协议规范经常更新，并创建新的协议版本。

大多数协议允许一定程度的可扩展性，这使得新的扩展逐渐出现，这些扩展是有意义支持的。

协议的解释有时会发生变化，即使规范保持不变。

本章提到的协议都是“应用层协议”，这意味着它们是通过更低层协议（如 TCP、UDP 和 TLS）传输的。它们本身也是随着时间变化的协议，会获得新的功能并受到攻击，因此处理安全性等方面的新方法会迫使 curl 适应和改变。

## 关于遵守标准和谁是对的

通常，有协议规范告诉我们如何针对特定协议发送和接收数据。我们遵循的协议规范是由 IETF 汇编和发布的 RFC 文档。

有些协议在最终的 RFC 中没有得到适当的文档化，例如，SFTP 就是其中之一，我们的实现是基于一个甚至不是最新可用版本的互联网草案。

协议是由两方说出的，就像在任何对话中一样，因此理解某事或解释规范中给定的指令有两种理解方式。此外，许多网络软件编写时，作者并没有非常注意规范，所以他们最终采取了一些捷径，或者也许他们只是以不同的方式解释了文本。有时候，甚至错误和缺陷会导致软件的行为方式不受规范的约束，有时甚至在规范中明确禁止。

在 curl 项目中，我们使用发布的规范作为行动规则，直到我们学到其他任何事情。如果流行的替代实现的行为与我们认为规范所说的不同，而且该替代行为在大型互联网上广泛使用，那么我们很可能会改变立场，改为像那些其他实现一样行事。如果服务器拒绝与我们交流，而我们认为我们遵循了规范，但当我们稍微弯曲规则时却可以正常工作，那么我们很可能最终会以这种方式弯曲规则——如果我们仍然可以成功地与其他实现进行交流。

最终，这是一个个人决定，并且在我们认为规范和现实世界不一致的每种情况下都值得讨论。

在最糟糕的情况下，我们会引入选项，让应用程序开发人员和 curl 用户最终决定 curl 应该做什么。我说“最糟糕”是因为通常很难要求用户做出这些决定，因为这通常涉及非常棘手的细节和怪异的情况，并且要求用户做出很多努力。我们应该尽最大努力避免将此类协议决策推给用户。

# curl 协议

# curl 支持的协议

curl 支持大约 22 种协议。我们说“大约”是因为这取决于您如何计算以及您认为是完全不同的协议。

## DICT

DICT 是一种字典网络协议，它允许客户端向字典服务器询问单词的含义或解释。参见 RFC 2229。Dict 服务器和客户端使用 TCP 端口 2628。

## FILE

FILE 实际上不是一个“网络”协议。它是一种 URL 方案，允许您告诉 curl 从本地文件系统获取文件，而不是从远程服务器上的网络获取。参见 RFC 1738。

## FTP

FTP 代表文件传输协议，是一种在客户端和服务器之间传输文件的旧（起源于 1970 年代早期）方式。参见 RFC 959。它多年来得到了很大程度的扩展。FTP 服务器和客户端使用 TCP 端口 21 加上一个端口，尽管第二个端口通常在通信过程中动态建立。

查看外部页面[FTP 与 HTTP 的区别](https://daniel.haxx.se/docs/ftp-vs-http.html)。

## FTPS

FTPS 代表安全文件传输协议。它遵循了在协议名称后添加'S'以表示该协议与普通 FTP 相同但添加了 SSL/TLS 安全层的传统。参见 RFC 4217。

这种协议在防火墙和其他网络设备上使用起来非常问题。

## GOPHER

为“在互联网上分发、搜索和检索文档”而设计，Gopher 在某种程度上是 HTTP 的前身，因为 HTTP 已经完全接管了相同的用例。参见 RFC 1436。Gopher 服务器和客户端使用 TCP 端口 70。

## HTTP

超文本传输协议，HTTP，是在网页和互联网上传输数据的最广泛使用的协议。参见 RFC 7230 用于 HTTP/1.1 和 RFC 7540 用于 HTTP/2，它的后继者。HTTP 服务器和客户端使用 TCP 端口 80。

## HTTPS

安全 HTTP 是通过 SSL/TLS 连接完成的 HTTP。参见 RFC 2818。HTTPS 服务器和客户端使用 TCP 端口 443。

## IMAP

互联网消息访问协议，IMAP，是用于访问、控制和“读取”电子邮件的协议。参见 RFC 3501。IMAP 服务器和客户端使用 TCP 端口 143。

## IMAPS

安全 IMAP 是通过 SSL/TLS 连接完成的 IMAP。这样的连接通常开始于一个“正常”的 IMAP 连接，然后通过 `STARTTLS` 命令升级为 IMAPS。

## LDAP

轻量级目录访问协议（LDAP）是一种用于访问和维护分布式目录信息的协议。基本上是数据库查询。参见 RFC 4511。LDAP 服务器和客户端使用 TCP 端口 389。

## LDAPS

安全 LDAP 是通过 SSL/TLS 连接完成的 LDAP。

## POP3

第 3 版邮局协议（POP3）是用于从服务器检索电子邮件的协议。参见 RFC 1939。POP3 服务器和客户端使用 TCP 端口 110。

## POP3S

安全 POP3 是通过 SSL/TLS 连接完成的 POP3。这样的连接通常开始于一个“正常”的 POP3 连接，然后通过 `STARTTLS` 命令升级为 POP3S。

## RTMP

实时消息传输协议（RTMP）是用于流式传输音频、视频和数据的协议。RTMP 服务器和客户端使用 TCP 端口 1935。

## RTSP

实时流媒体协议（RTSP）是一种网络控制协议，用于控制流媒体服务器。参见 RFC 2326。RTSP 服务器和客户端使用 TCP 和 UDP 端口 554。

## SCP

安全复制（SCP）协议旨在将文件复制到远程 SSH 服务器并从远程 SSH 服务器复制文件。SCP 服务器和客户端使用 TCP 端口 22。

## SFTP

SSH 文件传输协议（SFTP）提供了可靠数据流上的文件访问、文件传输和文件管理。SFTP 服务器和客户端使用 TCP 端口 22。

## SMB

服务器消息块（SMB）协议也称为 CIFS。它是一个应用层网络协议，主要用于在网络上的节点之间提供文件、打印机和串行端口的共享访问以及杂项通信。SMB 服务器和客户端使用 TCP 端口 485。

## SMTP

简单邮件传输协议（SMTP）是一种用于电子邮件传输的协议。参见 RFC 821。SMTP 服务器和客户端使用 TCP 端口 25。

## SMTPS

安全 SMTP 是通过 SSL/TLS 连接完成的 SMTP。这样的连接通常开始于一个“正常”的 SMTP 连接，然后通过 `STARTTLS` 命令升级为 SMTPS。

## TELNET

TELNET 是一种应用层协议，用于通过网络提供双向交互式文本通信功能，使用虚拟终端连接。参见 RFC 854。TELNET 服务器和客户端使用 TCP 端口 23。

## TFTP

Trivial File Transfer Protocol（TFTP）是一种协议，用于通过 UDP 进行简单文件传输，以从远程主机获取文件或将文件放置到远程主机上。TFTP 服务器和客户端使用 UDP 端口 69。
