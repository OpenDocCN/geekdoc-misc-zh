# 生物分子的分子动力学轨迹的问题特定分析

# 生物分子的分子动力学轨迹的问题特定分析

## Konrad Hinsen

我的名字是[Konrad Hinsen](http://dirac.cnrs-orleans.fr/~hinsen/)，我是法国奥尔良的[分子生物物理中心](http://cbm.cnrs-orleans.fr/?lang=en)的研究员。我的研究领域是分子生物物理学，特别是蛋白质的柔韧性和动力学研究。我的所有工作都基于计算方法，其中最重要的方法是[弹性网络模型](http://dirac.cnrs-orleans.fr/plone/Members/hinsen/elastic-network-models-for-proteins)和[分子动力学](https://en.wikipedia.org/wiki/Molecular_dynamics)（MD）模拟。此外，我的大部分工作涉及计算方法的开发，而不是已经建立的方法的应用。

这个案例研究涉及从 MD 模拟轨迹中提取信息，这是我领域中非常常见的一种工作类型。MD 模拟本身是相对标准的程序，使用几种众所周知的软件包之一执行。在一个具有几十个处理器的小型并行计算机上，它们需要几天到几周的时间，并产生一个所谓的轨迹文件，大小在一到十 GB 之间。分析这些轨迹以实际了解被模拟系统的情况是一个单独的步骤，这个步骤远没有标准化，意味着涉及大量问题特定的代码。这些代码与计算出的数量的图形一样，是工作流的结果。

对于可重现和可发布的工作流，在这种情况下存在三个具体挑战：

1.  轨迹文件的大小很难以可引用的方式发布，通常大于[Zenodo](http://zenodo.org/)或[figshare](http://figshare.com/)当前的上限。

1.  有一些 CPU 密集型任务通常在并行计算集群上以批处理模式运行，以及在桌面机器上交互式或几乎交互式地完成的探索性任务（运行大约一秒钟的短脚本）。大多数工作流管理系统不支持跨机器的依赖跟踪。计算集群通常具有有限的网络连接，这并没有帮助。

1.  当执行的大部分代码是问题特定的时，"软件包"和"工作流"之间的区别并不有用。更合适的代码结构是"在库中实现的成熟技术"、"问题特定脚本"以及在顶层的"少量脚本的协调"。必须捕获最后两个级别以实现可重现性。

### 工作流

![图示](img/khinsen.png) 可以以两个代码/数据包（[包 1](https://dx.doi.org/10.6084/m9.figshare.808594)，[包 2](https://dx.doi.org/10.6084/m9.figshare.808595)）和描述该研究的[文章](http://dx.doi.org/10.1063/1.4823996)的形式查阅下文描述的工作流程的已发布示例。

工作流程图实际上是带有附加工作流信息的数据流图。与大多数关注工作流程的方法（将工作流管理器、软件包、Web 服务等放在关注的中心）相比，我在这里描述的方法侧重于数据以及科学家与数据交互的方式。下面的工作流程不是关于"完成工作"，而是关于"开发和优化科学模型"。

数据流图显示了矩形中的代码，以及圆角框中的"被动"数据。代码由少量 Python 脚本组成，图中显示了其中四个。数据从上到下流动，如箭头所示，从整体输入的 MD 轨迹开始，最终显示计算量的图。三个标有"计算结果"的圆角框是中间结果，由 Python 脚本 1 和 2 计算并由 Python 脚本 3 和 4 使用。

从工作流程管理和可重现性的角度来看，数据项中最重要的区别是"人工输入"（实线轮廓）与"计算数据"（虚线轮廓）。人工输入代表科学模型，因此是此工作流程的主要输出。它由代码（Python 脚本 1 至 4）和数值参数（图中的一个）组成，尽管这种区分相当任意：每个参数都可以转换为脚本中的一行。计算数据包括进入期刊文章的图表，但也包括中间结果。在完全可重现的工作流程中，计算数据无需存储，因为可以随时重新计算。然而，通常最好明确地存储它，特别是如果重新计算需要很长时间。存储的计算数据对于希望更好地了解方法的科学家来说也更易于探索。

工作流程包括对模型和方法的迭代改进。处理工作流程的两个关键工具是：

+   版本控制系统如[git](https://git-scm.com/)用于跟踪变更。

+   用于协调计算的[ActivePapers](http://www.activepapers.org/)依赖管理器

相应地，项目的状态包括

+   存储在版本控制下的存储库跟踪"人工输入"项目随着项目的推进而发生的变化。

+   一个 ActivePaper 文件，其中存储了所有数据项的当前状态和依赖关系图。

有两种细化步骤的变体：添加新脚本或参数，修改现有脚本和参数。第一种类型，扩展数据流图，包括以下用户操作：

1.  编写新脚本。

1.  将其提交到版本控制。

1.  将脚本检入 ActivePaper。

1.  通过 ActivePapers 依赖管理器运行脚本。

保留数据流图的第二种类型略有不同：

1.  编辑脚本和参数。

1.  将更改提交到版本控制。

1.  将修改版本检入 ActivePaper。

1.  更新 ActivePaper。

第四步重新计算受第一步更改影响的所有数据。重新计算由*依赖图*引导，该图是从数据流图中获得的，通过将指向脚本的箭头重定向为指向脚本输出。ActivePapers 依赖管理器在执行脚本期间自动计算依赖图。用户无需明确处理（甚至知道）任何一个图。他们编写和运行脚本的方式与在可重现性成为问题之前的方式相同。[Sumatra](http://neuralensemble.org/sumatra/)和[noWorkflow](https://github.com/gems-uff/noworkflow)中使用类似的方法，但大多数工作流管理器采用相反的策略，让用户明确构建工作流，然后执行它。

通过复制 ActivePaper 文件和版本控制存储库，可以将项目从一台计算机转移到另一台计算机。在分子模拟中常见的情况是将漫长的计算转移到集群，上述过程中的第 4 步略有修改：ActivePaper 发送到集群，集群上执行“运行新脚本”或“更新”操作，然后将修改后的 ActivePaper 文件传输回用户的桌面计算机。所有工具都具有命令行界面，可以通过 ssh 连接轻松使用它们。

方法开发项目往往规模较小，涉及少数人。通过让单个人执行每个细化步骤，甚至所有细化步骤，可以轻松避免协调文件修改的陷阱。其他参与者当然可以贡献想法，并检查项目的当前状态进行分析。

项目结束时，ActivePaper 文件可以发布，使所有代码和数据对其他研究人员可用。ActivePaper 文件包含项目的完整最终状态（尽管不包括历史记录），这意味着任何人都可以从该状态继续。新项目的 ActivePaper 文件可以通过数字对象标识符（DOI）重用已发布的 ActivePaper 文件中的项目，使其他研究人员能够构建已发布的计算工作。DOI 也可用于期刊文章中的引用。

### 痛点

当今计算科学家面临的主要实际困难是，他们大多数人在成长过程中所使用的工具和实践与可重复性不兼容。这在分子模拟领域尤为明显，可重复性发布的研究仍然很少见。要实现可重复性工作，就需要采用新的工具和习惯，并修改现有软件以便与可重复工作流程集成。有一种永久的诱惑是为了更快的科学进步而放弃可重复性。

当前用于可重复性研究的工作流工具的不成熟性增加了另一层认知负担。在上述工作流中，这主要体现在使用单独的工具来跟踪历史和依赖关系上。当今的版本控制系统主要面向软件开发，而不是计算科学，因此不容易扩展为满足研究所需的依赖管理。另一方面，在当前阶段很难证明编写与依赖管理集成的新版本控制软件是值得的。

ActivePapers 系统强加的一个主要限制是，所有代码必须用 Python 编写，所有数据必须存储在 HDF5 数据集中。虽然 Python 在分子模拟中足够流行，使第一个限制非常可接受，但 HDF5 仍然是数据存储的罕见选择，尽管由于诸如[H5MD](http://nongnu.org/h5md/)等倡议的推动，情况正在发生变化。

使用特定工具很少足以确保可重复性。工具只能处理*可复制性*，即追踪所有计算依赖关系的技术方面，以便可以完全重新运行计算。在科学层面上实现可重复性要求所有步骤都能轻松被同行科学家理解和验证。为实现这一目标而制定的最佳实践尚未完全发展。从上述工作流应用中得出的一个观察结果是，人类检查中间结果的访问是至关重要的。这表明了许多小型脚本的整体结构，每个脚本都执行一个明确定义的任务，并通过明确存储的数据集进行通信。

### 主要优势

传统的更改脚本并在 shell 中交互运行的工作流程极易出错。最常见的错误是在另一个脚本更新后忘记重新运行脚本，导致其输入数据发生变化。在采用可重现性支持工具之前，我经常发现自己查看数据文件，并想知道哪个确切的脚本执行顺序产生了它。这个问题通常在写论文时出现。即使对于今天最简单的“材料和方法”部分，通常也需要在编写文档时查找脚本中的参数和其他选择，这往往是一个发现混乱的时刻。当完整的最终项目状态可供检查，并由软件工具保证完整和一致时，这个问题就不再存在。

### 关键工具

我工作流程中的关键工具是[ActivePapers](http://www.activepapers.org/)工具集，实际上是专门设计用于支持原子和分子模拟中的可重现性。它特别支持

+   通过在[HDF5](https://www.hdfgroup.org/HDF5/)文件中高效存储大型数据集，并将依赖信息存储为 HDF5 元数据，进行大数据集的计算。

+   通过在单个 HDF5 文件中存储所有数据集及其依赖图，跨机器进行依赖跟踪，这样可以轻松地从一台机器复制到另一台机器。

工作流程中唯一支持可重现性的工具是版本控制系统。

### 问题

#### 对你来说，“可重现性”是什么意思？

鉴于我的工作完全是计算性的，我的长期目标是实现完全的可重现性，从模拟的规范开始，到进入期刊文章的图表结束。目前这个目标是不现实的，因为模拟软件包不支持可重现性。一个问题是数值舍入误差的积累，这些误差在处理器和编译器之间的标准化不足，无法实现可重现性。另一个问题是广泛使用随机数生成器，而用户无法控制随机种子。

出于这个原因，我为这个案例研究设定了一个更为谨慎的目标：通过使用分子动力学模拟轨迹作为输入，实现轨迹分析步骤的可重现性，就好像它们是我无法控制的实验数据一样。这是一个有用的妥协，因为轨迹分析技术的发展是这项工作的核心科学主题。

#### 你认为在你的领域中可重现性为何重要？

大多数分子动力学模拟研究非常复杂，如果没有可重现性，就无法确定实际计算的内容。大多数错误并不会导致明显错误的结果，而是导致一个略有不同的结果，这个结果很可能是正确的。

#### 你是如何或从何处了解到可重现性的？

我自己开发了它们，经过对现有技术和实践的仔细调查后，发现没有适合分子模拟特定需求的东西。

#### 在你的领域进行可重复研究的主要挑战是什么，你有什么建议？

主要挑战是人为和社会性的。我的大多数同事都经历过不可重复性带来的问题，但很少有人愿意投入额外的努力做得更好，许多人仍然不知道已经存在的可重复性工具和实践。在我的领域，期刊通常不要求发布软件或数据，并且在任何情况下都不鼓励可重复性。技术挑战存在于最流行的软件包不支持可重复性，但如果社区有足够的动力，技术挑战可以轻松应对。

#### 你认为进行可重复研究的主要动机是什么？

+   对我的结果的正确性更有信心。

+   能够安全地在之前的工作基础上构建（无论是我自己还是他人的）

#### 在你的领域，你会推荐哪些最佳实践？

如果在我的领域发布软件和数据成为标准，我已经很高兴了。在基本要求成为标准之前，很难推荐更复杂的实践。
