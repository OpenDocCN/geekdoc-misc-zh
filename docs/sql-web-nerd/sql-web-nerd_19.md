| ![1998 年 10 月 18 日，星期日的查尔斯划船赛。  从步行桥到哈佛商学院](img/hoc-25.tcl) |
| --- |

## 附录 A：设置您自己的 RDBMS

由[Philip Greenspun](http://philip.greenspun.com/)编写，是 Web 网络数据库编程指南的一部分 |

* * *

本书是为麻省理工学院的学生编写的，他们可以访问我们的 Web/db 开发系统。第二类可以轻松使用本书的读者是在 Bloatco，Inc.工作的企业奴隶，在那里他们有一个专业维护的 Oracle 服务器。如果你不幸不属于这些类别，你可能需要安装和维护自己的 RDBMS。本附录旨在帮助你选择并运行一个适合学习 SQL 的 RDBMS，并让你逐渐发展成为运行生产网站的能力。

### 选择关系数据库管理系统供应商（快速而粗糙）

![斯德哥尔摩市中心的水果和花卉市场](img/stockholm-fruit-and-flower-market-101.tcl) 选择数据库管理系统的快速而粗略的方法是从一份长期看来似乎可行的产品列表开始。基本上你可以从以下三种中选择：

+   微软 SQL Server（受微软整体市场影响力的支持）

+   Oracle（你不会被解雇）

+   PostgreSQL（免费开源）

如果想忽略 RDBMS，集中精力攻击更高层次的应用程序挑战，Oracle 是最好的选择。它是功能最强大且功能最丰富的 RDBMS。你可以在一台 500 美元的个人电脑上或者在一台 500 万美元的多重冗余服务器配置中运行相同的软件。

PostgreSQL 是一个有趣的替代选择。它是免费且开源的。与 Oracle 一样，它具有乐观锁定（写者不需要等待读者；读者不需要等待写者）。PostgreSQL 的安装和维护可能比 Oracle 更容易。PostgreSQL 是从头开始构建的对象关系数据库，并提供了一些 Oracle 仍然缺少的重要功能。然而，更关心支持、可靠性和冗余可能性的业务人士可能会质疑你选择 PostgreSQL 的决定。请查看[www.postgresql.org](http://www.postgresql.org)了解这个快速发展系统的最新信息。

微软 SQL Server 是一个不太有趣的选择。微软从 Sybase 的源代码开始，并逐渐改进了产品。该系统在 Web 使用中可能存在问题，因为其传统的悲观锁定架构。如果您雇用了一个新程序员，他或她执行了一个返回缓慢的查询，用户将无法更新信息、下订单或发表评论直到查询完成。理论上，这些锁的管理可以手动调整，但实际上 Web 程序员从来没有时间、能力或意愿正确管理锁。在功能方面，SQL Server 通常落后于 Oracle，例如，能够在数据库内运行 Java，对数据仓库方便的 SQL 扩展，或者帮助组织应对极端性能或可靠性需求的分层产品。尽管如此，SQL Server 可能不会消失，因为微软在服务器领域的很大一部分拥有如此强大的影响力。因此，如果您所在的组织 100%使用微软，并且人员已经熟练掌握维护 SQL Server，继续使用它是一个合理的技术决定。

### 选择关系数据库管理系统供应商（从第一原则出发）

以下是我们认为在选择用于网站后端的关系数据库管理系统时重要的因素：

1.  管理成本/复杂性

1.  锁管理系统

1.  全文索引选项

1.  VARCHAR 数据类型的最大长度

1.  运行标准编程语言的内部便利性

1.  支持

#### 管理成本/复杂性

![从市政厅俯瞰斯德哥尔摩](img/stockholm-from-stadshuset-6.tcl) 粗糙的关系数据库管理系统管理是复杂网站停机的最常见原因之一。如果您没有经验丰富的数据库管理员团队来为您的网站提供支持，您应该考虑外包数据库管理或运行简单的关系数据库管理系统，如 PostgreSQL。

#### 锁管理系统

![斯德哥尔摩中央斯坦古城皇宫的卫兵](img/stockholm-gamla-stan-royal-palace-guard-80.tcl) 关系数据库管理系统存在是为了支持并发用户。如果没有 100 人同时更新信息，你可能最好使用 Perl 脚本而不是商业关系数据库管理系统（即 100 MB 的他人 C 代码）。

所有数据库管理系统都使用锁来处理并发问题。在执行语句修改某些数据之前，必须获取一个锁。在持有此锁时，没有其他同时执行的 SQL 语句可以更新相同的数据。为了防止另一个用户读取半更新的数据，当持有此锁时，没有同时执行的 SQL 语句甚至可以*读取*数据。

*读者必须等待写者完成写作。写者必须等待读者完成阅读。*

这种系统实现简单，在研究实验室中运行良好，并且可以在数学上证明正确。唯一的问题是？它不起作用。有时它不起作用是因为有 bug。特定 RDBMS 对此方案的实现在有大量用户时会混乱和卡住。更常见的情况是它不起作用是因为悲观锁定*是*一个 bug。程序员编写了一个长达一小时的后端查询，却忘记了这样做会导致网站上的每个更新页面等待整整一个小时。

使用 Oracle RDBMS，*读者永远不用等待写入者，写入者也永远不用等待读者*。如果一个 SELECT 从 9:01 开始读取，并在 9:02 遇到另一个会话更新的行，Oracle 会进入回滚段，并找出 SELECT 的预更新值（这保留了 ACID 测试的*隔离*要求）。事务不需要锁定，除非它正在修改表，即使是这样，也只在要修改的特定行上锁定。

这是您希望用于网站的关系数据库管理系统锁定架构。Oracle 和 PostgreSQL 提供了这种架构。

#### 全文索引选项

假设用户说他想了解关于“dogs”的信息。如果您在数据库中有一堆字符串，您将不得不使用类似于以下查询进行搜索:

> ````
> select * from magazines where description like '%dogs%';
> ````

![斯德哥尔摩斯坎森的一扇门](img/stockholm-skansen-door-55.tcl) 这需要关系数据库管理系统读取表中的每一行，这样很慢。而且，这不会显示描述中包含“dog”一词的杂志。

全文索引器在磁盘上构建一个数据结构（索引），这样 RDBMS 不再需要扫描整个表以找到包含特定单词或单词组合的行。该软件足够智能，可以考虑单词词干而不是单词。因此，“running”和“run”或“dog”和“dogs”可以在查询中互换。全文索引器通常还能够根据用户输入的短语对文档数据库表进行相关性评分，以便您查询最相关的匹配项。

最后，现代文本搜索引擎非常聪明地处理单词之间的关系。因此，它们可能提供一个不包含“dog”一词但包含“Golden Retriever”的文档。这使得分类广告、讨论论坛等服务对用户更加有用。

关系数据库管理系统供应商逐渐将全文索引纳入其产品中。遗憾的是，没有关于使用此索引查询的标准。因此，如果您弄清楚如何使用 ConText 查询 Oracle 8.1 中与“running”或其同义词相关的行，那么该 SQL 语法将无法用于询问具有相应全文索引选项的 Microsoft SQL Server 7.0 相同问题。

我最好的经验是与 Illustra/PLS 结合使用。我给它输入了 500 条短的摄影设备分类广告，然后问："与 *Nikon* 最相关的词是什么"。根据 Illustra/PLS 的答案：*Nikkor*（尼康的镜头品牌名）。

#### VARCHAR 数据类型的最大长度

![加州马里布。](img/malibu-long-hair-37.tcl) 你可能天真地期望关系数据库管理系统提供数据存储的抽象。在定义一个列来容纳字符字符串之后，你希望能够给 DBMS 一个包含十个字符的字符串或一个包含一百万个字符的字符串，并希望每个字符串都能尽可能高效地存储。

实际上，当前的商业系统在存储意外长的数据方面非常糟糕，例如，Oracle 只允许在 VARCHAR 中使用 4,000 个字符。如果你正在构建一个企业会计系统，这还可以接受，但对于公共网站来说就不好了。你无法确定用户的分类广告或公告板帖子的长度会是多少。现代数据库供应商通常提供字符大对象（CLOB）数据类型。CLOB 理论上允许你存储任意大的数据。然而，在实践中，对 CLOB 列有很多限制，因此它并不是很有用。例如，在 Oracle 8i 中，你不能在 SQL WHERE 子句中使用 CLOB，因此前面的 "LIKE '%dogs%'" 将失败。你无法在 LOB 列上构建标准索引。你可能很难将字符串放入或取出 LOB。Oracle SQL 解析器只接受长度最长为 4,000 个字符的字符串文字。之后，你将不得不使用特殊的 C API 调用。LOB 会让你的 Oracle 数据库管理员头痛：它们破坏了 EXPORT 和 IMPORT 的语义。至少在 Oracle 8.1.6 中，如果你导出包含 LOB 的数据库，你将无法将其导入到另一个 Oracle 安装中，除非该安装恰好有一个与在导出的安装中存储 LOB 的表空间同名的表空间。

PostgreSQL 有一个理论上没有限制的 "text" 数据类型。然而，整个 PostgreSQL 行的长度不能超过 8,000 个字符。所以实际上，在这方面 PostgreSQL 比 Oracle 功能更弱。

*** 调查 Microsoft SQL Server，但据我所知，它是 255 个字符！ *****

*购买者自负。*

#### 内部运行标准编程语言的便利性

在 Oracle 中，运行 Java 和准标准的 PL/SQL 相当容易。在 PostgreSQL 中，运行 Perl、Tcl 和类似于 PL/SQL 的 PL/pgSQL 也相当容易。在 Microsoft SQL Server *****（需要调查）中。

#### 支持

理论上，你不会经常需要支持，但你希望确保当你需要时，能够得到一个非常重视关系型数据库可靠性和正常运行时间的组织。### 支付关系型数据库供应商 ![大节省。夏威夷](img/big-save-30.4.jpg) “PostgreSQL 可免费获得，”是 PostgreSQL 文档第一章的开头。微软的定价排名第二最容易理解：访问[`www.microsoft.com/sql/`](http://www.microsoft.com/sql/)并点击“定价和许可”。1998 年的价格为$4400，可用于 4-CPU 机器，用于 Web 站点后面。截至 2000 年 9 月，他们为 4-CPU Web 服务器收费$20,000 或$80,000，具体取决于您想要“企业”版还是“标准”版。

尽管拥有工业遗产，Oracle 比微软要便宜得多。微软为 SQL Server 的残缺开发者版本收费$500；而 Oracle 允许开发者从 technet.oracle.com 免费下载完整版本。微软每 CPU 要价$20,000；Oracle 会尽力争取最优惠的交易，但最近一直向初创公司出售为期两年的“车库”许可证，售价为$10,000。

### 性能

![猩猩。奥杜邦动物园。路易斯安那州新奥尔良。](img/no-zoo-orangutan-lazing-13.tcl) 请放心，任何关系型数据库管理系统产品都会相当慢。我们曾经有 70,000 行数据要插入 Oracle8。每行包含六个数字。结果发现数据并不是最方便的导入格式，所以我们编写了一个一行的 Perl 脚本来重新格式化它。读取所有 70,000 行，重新格式化并将它们写回磁盘的一个文件不到一秒。然后我们开始从自定义 C 应用程序向 Oracle 8 表中插入它们。大约需要 20 分钟（每秒 60 行）。通过使用 SQL*Loader，我们可能可以接近每秒 1000 行，但仍然比 Perl 脚本慢 70 倍。为应用程序员提供 ACID 保证总是会很慢。

有几种方法可以实现高性能。如果你的大部分活动都是查询，你可以先购买一台大型多处理器计算机，并配备足够的 RAM 来一次性容纳整个数据库。不幸的是，如果你按 CPU 付费，你的关系型数据库管理系统（RDBMS）供应商可能会大肆消耗你的银行账户，这是你不会忘记的。而且如果你处理大量的插入和更新，那些充斥着 RAM 的 CPU 对你也没有帮助。瓶颈将是磁盘主轴的竞争。解决这个问题的方法是唱着“哦，我有一个名叫西格特的朋友。” 磁盘很慢。非常慢。实际上几乎比计算机慢了一百万倍。最好避免像我们在 SELECT 的情况下那样永远不要访问磁盘，方法是购买足够的 RAM 来容纳整个数据集。然而，ACID 测试中的持久性要求意味着一些事务的记录将必须写入在断电情况下不会被抹去的介质上。如果一个磁盘只能每秒执行 100 次寻址，而且你只有一个磁盘，那么你的 RDBMS 将很难做到每秒更新大约 100 次。

Oracle 比磁盘的写入/秒容量处理更多的事务。数据库管理系统所做的是将大致同时来自不同用户的事务批处理。它将足够的数据写入磁盘使它们都是持久的，然后一次返回给这些用户。

你应该做的第一件事是镜像所有磁盘。如果你的整个数据库不在 RAM 中，这会加快 SELECT 的速度，因为磁盘控制器可以从更接近所需磁道的磁盘读取。如果你使用“RAID 5 级别”，数据会跨多个磁盘进行条带化，那么相反的效果就会产生。然后，关系型数据库管理系统必须等待五个磁盘进行寻址，然后才能提供几行数据。直接镜像，或“RAID 1 级别”，是你想要的。

你接下来必须做的决定是"要多少个磁盘？" [*Oracle8i DBA 手册*](http://www.amazon.com/exec/obidos/ASIN/0072121882/pgreenspun-20)（Loney 和 Theriault；1999）推荐最低的 7x2 磁盘配置作为专用于数据库服务的机器的*折衷*。他们的*解决方案*从 9x2 磁盘开始，一直到 22x2。其想法是将可能并行写入的文件保存在不同的磁盘上，以便一个磁盘可以执行 2200 次/秒的寻址，而不是 100。

这是 Oracle8 DBA 手册对避免主轴竞争的 17 磁盘（镜像 X2）解决方案：

> | 磁盘 | 内容 |
> | --- | --- |
> | 1 | Oracle 软件 |
> | 2 | 系统表空间 |
> | 3 | RBS 表空间（如果事务出现问题，则回滚段） |
> | 4 | 数据表空间 |
> | 5 | 索引表空间（更改数据需要更改索引；这允许这些更改并行进行） |
> | 6 | 临时表空间 |
> | 7 | 工具表空间 |
> | 8 | 在线重做日志 1，控制文件 1（这些会在一个 22 磁盘的机器上分开） |
> | 9 | 在线重做日志 2，控制文件 2 |
> | 10 | 在线重做日志 3，控制文件 3 |
> | 11 | 应用软件 |
> | 12 | RBS_2 |
> | 13 | DATA_2（通常与 DATA 中的表并行抓取的表） |
> | 14 | INDEXES_2 |
> | 15 | TEMP_USER |
> | 16 | 存档的重做日志目的地磁盘 |
> | 17 | 导出转储文件目的地磁盘 |

现在你有了很多磁盘，你最终必须非常谨慎地考虑如何在它们之间布置数据。"企业"关系数据库管理系统会迫使你考虑数据文件应该放在哪里。在一台只有一个磁盘的计算机上，这只是令人讨厌的，让你无法进行开发；你可能会选择像 PostgreSQL 这样的简单关系数据库管理系统获得类似的性能。但是企业数据库具有灵活性，因为你知道哪些数据区域往往会同时访问，而计算机不知道。因此，如果你有一台带有一排磁盘驱动器的适当数据库服务器，智能的手动布局可以将性能提高五倍。

### 不要忘记备份

![燃烧的汽车。1995 年新泽西。](img/car-roast-23.tcl) 要害怕。非常害怕。标准的 Unix 或 Windows NT 文件系统备份不会给你留下一致的、因此可恢复的数据库备份。假设你的关系数据库管理系统将数据库存储在两个不同的 Unix 文件系统文件中，foo.db 和 bar.db。每个文件的大小为 200 MB。你启动备份程序并将文件 foo.db 写入磁带。当备份正在进行时，一个需要对 foo.db 和 bar.db 进行更改的事务到来。关系数据库管理系统进行了这些更改，但对 foo.db 的更改发生在已经写入磁带的文件的一部分上。最终，备份程序开始将 bar.db 写入磁带，并写入带有更改的新版本。你的系统管理员在上午 9:00 到达并通过快递将磁带送往离岗存储设施。

![斯德哥尔摩斯坎森的壁炉](img/stockholm-skansen-fireplace-51.tcl) 中午时分，一群愤怒的用户聚集在您的办公室外，对您引入框架并未在 IMG 标签上包含 WIDTH 和 HEIGHT 标签感到愤怒。您派遣其中一名平面设计师出去解释在向副总裁演示时从本地磁盘运行时看起来是多么“酷”。这群人用石头砸死了他，然后焚烧了您的服务器农场。您设法用一把那种坚不可摧的 HP Unix 键盘从废墟中挣脱出来。您设法让 HP 灾难支持人员让您暂时使用他们的机器，并自信地加载您的备份磁带。令您震惊的是，关系数据库管理系统在恢复后出现了问题。原来在 foo.db 和 bar.db 中有链接数据结构。备份期间发生的一个事务导致了所有数据的完全不可用。也许您认为这不是世界上最稳健的关系数据库管理系统设计，但 SQL 标准或制造商的文档中没有任何内容表明 Oracle、Postgres 或 SQL Server 不能以这种方式工作。

完全镜像可以防止由于媒体故障而离线。但是，您仍然需要数据库的快照，以防某人对 DELETE FROM 语句有些激动，或者出现上述情况。

有两种方法可以备份关系型数据库：离线和在线。对于离线备份，您需要关闭数据库，从而阻止事务发生。大多数供应商希望您使用他们的实用程序制作离线数据库的转储文件，但实际上只需备份 Unix 或 NT 文件系统文件即可。离线备份通常由保险公司和其他大型数据库用户使用，他们一天只需要进行八小时的交易。

每个关系数据库管理系统供应商都有一种宣传的在线备份方法。它可以简单到“调用此函数，我们将花几个小时为您构建一个包含一致数据库但减去您调用该函数后发生的所有事务的转储文件”。以下是将 Oracle 数据库快照导出到转储文件的 shell 命令：

> ````
> exp DBUSER/DBPASSWD file=/exportdest/foo.980210.dmp owner=DBUSER consistent=Y
> 
> ````

这将导出由 DBUSER 拥有的所有表，如果表在转储开始后经历了事务，则从回滚段中提取旧行。如果你阅读[Oracle 性能调优](http://www.amazon.com/exec/obidos/ASIN/1565922379/pgreenspun-20)（Gurry 和 Corrigan 1996; O'Reilly），你会发现一些黑暗警告，*必须*定期导出以排除 Oracle 损坏其内部数据结构的情况。导出的另一个好处是，定期删除所有表并导入它们是碎片化数据的绝佳方式。在 ArsDigita，我们每晚都会导出每个客户的 Oracle 数据库，除了那些拥有几 TB 数据的少数客户。

如果你的数据库太大，无法导出到磁盘并且无法脱机？这是许多经验丰富的 IT 团队实践的一种技术：

+   打破镜像。

+   从数据库认为是脱机的磁盘备份。

+   重新建立镜像。

如果备份过程中出现在线磁盘故障怎么办？事务会丢失吗？不会。重做日志位于与数据库其余部分分开的磁盘上。这提高了日常操作的性能，并确保可以在镜像断开时恢复发生的事务，尽管会有一些离线时间。一些组织有三个镜像。他们可以拔掉一组物理磁盘并备份它们，而不会在备份窗口期间发生驱动器故障导致数据库管理系统离线的风险。

这里的教训有几个。首先，无论你的备份程序是什么，请确保定期进行恢复测试。其次，请记住，大多数公司的 RDBMS 的备份和维护是由全职员工完成的，称为“dba”，即“数据库管理员”。如果软件按照广告宣传的那样运行，你可以期望在安装期间经历几天的痛苦，然后定期遇到痛苦以保持与改进功能的同步。然而，dba 们赚取他们相对丰厚的薪水。没有任何营销炒作足以使 C 程序按照广告宣传的那样运行。这对于关系数据库管理系统和文字处理软件都是一样的。在大型安装中，解决错误可能是一项全职工作。通常这意味着找到解决方法，因为供应商在修复问题方面出奇的慢。另一项全职工作是追踪那些由于忘记构建索引或不太了解 SQL 而执行查询所需时间比必要时间长 1000 倍的用户。儿童医院有三名全职 dba，他们工作努力。

如果所有这些听起来相当乏味，只是为了确保你的数据明天还在，你可能会因为知道 Oracle dba 总是供不应求，年薪从 6 万到 8 万美元起步而感到振奋。当互联网泡沫破裂时，你的“HTML 程序员”朋友在地铁里唱歌时，你将在某个大型金融服务公司轻松自在。

我们以佩林·哈金斯的话作结。一个参与 Web/db 问题和答案论坛（[`www.arsdigita.com/bboard/q-and-a.tcl?topic=web/db`](http://www.arsdigita.com/bboard/q-and-a.tcl?topic=web/db)）的参与者问是否将数据库查询缓存到 Unix 文件中会加快他的 Web 服务器速度。以下是佩林的回答：

> "现代数据库使用 RAM 中的缓冲来加快对经常请求的数据的访问。你不必采取任何特殊措施来实现这一点，除了很好地调整你的数据库（可能需要你的余生）。"

### 参考

+   [Oracle8i 服务器备份和恢复指南](http://www.oradoc.com/keyword/backup_guide)，Oracle 文档集的一部分

+   [Oracle 服务器管理员指南](http://www.oradoc.com/keyword/server_admin_guide)，Oracle 文档集的一部分

+   [Oracle 8i 备份和恢复](http://www.amazon.com/exec/obidos/ASIN/0072127171/pgreenspun-20)（Velpuri 2000; Oracle Press）

* * *

[philg@mit.edu](http://philip.greenspun.com/)

### 读者评论

> 我想指出这一点：- Oracle 9i 现在显然已经成为[更好的](http://www.xmldatabases.org/radio/xmlDatabases/2002/06/25.html)[XML 数据库](http://www.xml.com/pub/a/2001/10/31/nativexmldb.html")之一。虽然我对[PostgreSQL 的实现](http://gborg.postgresql.org/project/xpsql/projdisplay.php)是否更好或者可比性没有实际经验，但值得注意的是，即使[Yukon](http://www.microsoft.com/sql/yukon/default.asp)[可能不会](http://www.extremeexperts.com/sql/articles/Yukon.aspx)具备这一功能。
> 
> -- Akshay R, 2004 年 5 月 25 日
> 
> 自从 MS Sql Server 7 以来，varchar 数据类型可以容纳 8000 个字符。（不清楚早期版本）。据说 MS Sql Server 2005 Yukon 可以允许在存储过程中使用.NET 代码。在我看来，MS Sql Server 的主要限制是缺少"Oracle Forms 和 Reports"。Yukon 应该解决这个问题。
> 
> -- Louis N, 2004 年 7 月 29 日
> 
> PostgreSQL *确实*支持任意长的文本字段，我至少从 7.3（可能是 7.2）时代开始使用它：
> 
> `SELECT length(nota) as size from articulo order by size desc;
> 
> 大小
> 
> -------
> 
> 70720
> 
> 56067
> 
> 38961
> 
> 34634
> 
> 33388
> 
> (...)`
> 
> -- Gunnar Wolf, 2004 年 12 月 17 日

添加评论
