# C/C++迁移到 Rust 的指南

这本书是为熟悉 C 或 C++的人准备的，他们正在考虑使用 Rust。

在我们讨论 Rust 是什么，或者为什么在*某些情况下*它可能更可取于 C/C++之前，让我们考虑一下那些必须不或者不应该失败的关键任务的软件。

+   操作系统服务和守护进程

+   物联网设备

+   工业控制软件

+   医疗设备 - MRI、超声波、X 射线、呼吸机等。

+   高可用性服务器/数据库/云存储等。

+   航空电子学、遥测、火箭技术、无人机等。

所有这些代码必须尽可能高效和可靠地运行。它必须在设备上连续运行数天、数周、数月，或者最好是数年而不出现故障。它不能够遭受间歇性的冻结、不稳定的性能、内存泄漏、崩溃或其他问题，而不影响其目的。

通常这样的软件会用 C 或 C++编写，但考虑到这些每天都可能影响这些语言的编程问题：

+   悬空指针。程序调用无效指针导致崩溃。

+   缓冲区溢出/溢出。代码写入超出分配缓冲区的范围，导致内存损坏或页面异常。

+   内存泄漏。分配内存*或资源*的代码没有调用相应的释放操作。C++提供了诸如智能指针之类的类和 RAII 之类的技术来减轻这些问题，但问题仍然存在。

+   数据竞争。多个线程同时写入数据，导致数据损坏或其他不稳定行为。

Rust 通过设计阻止了这些不良事件的发生。而且它在运行时不会影响性能，因为所有这些事情都在编译时进行检查：

+   对象生命周期会自动跟踪，以防止内存泄漏和悬空指针。

+   数组和集合的长度是强制执行的。

+   通过严格执行互斥锁/守卫和对象所有权，可以防止数据竞争条件。

通过编译器的检查的代码被转换为与等效的 C 或 C++具有相似性能和速度的机器代码。

这是一种“零成本”方法。编译器强制执行规则，以确保与 C 或 C++中等效且正确编写的程序相比，没有运行时成本。安全性不会影响性能。

此外，Rust 与 C 兼容。你可以从 Rust 中调用 C，或者从 C 中调用 Rust，使用外部函数接口。你可以选择重写代码库的关键部分，而保持其余部分不变。

例如，Firefox 浏览器使用 Rust 来分析视频流数据 - 标头和类似的内容，其中损坏或恶意代码可能会使浏览器不稳定，甚至是可利用的。

## 为什么选择 Rust？

让我们首先说，如果你有可靠的工作代码，那么对于这个问题的答案就是“没有理由”你应该考虑迁移。

但是，如果你的代码*不*工作或*不*可靠，或者*还没有*被编写，或者需要进行重大重写，那么也许你已经回答了自己的问题。

你可以用 C/C++编写代码或修复问题，在这种情况下，你必须处理语言没有保护你的所有不安全问题。或者你可以考虑选择一种安全设计的语言，这是保护你免受在代码应该准备投入生产时出现错误的好方法。

## Rust 不是魔法棒

尽管语言可以保护你免受一些事情，但它无法保护你免受以下问题：

+   一般的竞争条件，比如线程之间的死锁

+   无界增长，例如一个循环将值推送到向量，直到内存耗尽。

+   应用逻辑错误，即与基础语言无关的错误，例如遗漏应该说“if door_open { sound_alarm(); }”的行。

+   明确的不安全部分执行不安全和错误的操作

+   LLVM 中的错误或 Rust 控制范围之外的东西。
